# Лабораторная работа №2

## Трекинг объекта на видео по ключевым точкам

**Выполнили работу:** Никита Кулаков, Артём Зинатулин, Алина Мухомедьярова

### 1. Цель работы

Реализовать простой алгоритм трекинга объекта на видео на основе ключевых точек и гомографии, протестировать его на наборе тестовых роликов и на собственном видео, а также проанализировать устойчивость и ограничения подхода.

Входом для программы является видео, у которого первый кадр содержит крупное изображение объекта. На последующих кадрах, пока объект виден, вокруг него должна рисоваться рамка с подписью.

### 2. Теоретическая база

В основе реализации лежит классический подход **feature-based трекинга**:

- **Ключевые точки (features)**: локально выделимые участки изображения (углы, текстурные фрагменты), которые можно надёжно находить на разных кадрах.
- **Дескрипторы**: компактное численное описание окрестности ключевой точки, позволяющее сопоставлять точки между кадрами.
- **Сопоставление (matching)**: поиск пар «точка на объекте — точка на кадре видео» по расстоянию между дескрипторами.
- **Гомография**: проективное преобразование (3×3 матрица), которое переводит координаты плоского объекта из первой системы координат (первый кадр) в координаты текущего кадра. По гомографии можно восстановить положение углов объекта и нарисовать рамку.
- **RANSAC**: метод робастной оценки гомографии, отбрасывающий выбросы среди пар соответствий.
- **Оптический поток (Lucas–Kanade)**: отслеживание смещения уже найденных точек из кадра в кадр, что позволяет плавно обновлять оценку гомографии и уменьшать «дёрганье» рамки.

В данной работе:

- В качестве детектора и дескриптора используется **ORB** — быстрый, бинарный и свободный аналог SIFT/SURF.
- Для сопоставления дескрипторов применяется **BFMatcher** с метрикой Hamming и **тест Лоу (ratio test)** для отсечения ложных совпадений.
- Гомография оценивается функцией `cv2.findHomography` с RANSAC, затем проходит ряд логических проверок (количество инлиеров, ошибка репроекции, форма и площадь рамки).

Объект предполагается **плоским и текстурным**, что делает модель гомографии физически обоснованной.

### 3. Описание разработанной системы

#### 3.1. Структура проекта

- `tracker.py` — основной модуль с реализацией трекера:
  - класс `TrackingConfig` — параметры работы (пути к видео, пороги, флаги отладки и пр.);
  - класс `Tracker` — инкапсулирует состояние и алгоритм трекинга;
  - функции инициализации видео, логгера, детектора ORB, матчера, проверки гомографии и отрисовки рамки.
- `batch_tracker.py` — скрипт для пакетной обработки всех видео в папке `videos/input` с сохранением результатов в `videos/output`.
- `videos/input/` — входные видео:
  - тестовые ролики с картиной Моны Лизы (оригинал и варианты с блюром),
  - собственное видео с похожим объектом (`copybook.mov`).
- `videos/output/` — результаты трекинга в виде обработанных роликов.

#### 3.2. Алгоритм трекинга

Алгоритм реализован в классе `Tracker` и включает следующие основные шаги.

**Инициализация (первый кадр):**

1. Открывается входное видео и считывается первый кадр.
2. Функция `select_object_roi` выбирает **область интереса (ROI)**. В текущей версии в качестве объекта берётся **весь первый кадр** (что соответствует постановке задачи, когда первый кадр — крупный план объекта).
3. Для изображения объекта и первого кадра вычисляются ключевые точки и дескрипторы ORB.
4. Отбирается ограниченное число ключевых точек для отслеживания оптическим потоком (до `FLOW_MAX_POINTS`).
5. Инициализируется состояние гомографии:
   - если объект совпадает с целым кадром — в качестве начальной гомографии берётся единичная матрица;
   - иначе ожидание первой «хорошей» гомографии.
6. На первый кадр рисуется исходная прямоугольная рамка и подпись.

**Обработка каждого следующего кадра:**

Для каждого кадра выполняется метод `process_frame`:

1. Кадр переводится в оттенки серого.
2. Сначала пытаемся **обновить гомографию по оптическому потоку**:
   - с помощью `cv2.calcOpticalFlowPyrLK` отслеживаются точки из предыдущего кадра;
   - по парам «исходные точки на объекте — текущие точки в кадре» оценивается гомография `H_flow` (RANSAC);
   - гомография проверяется функцией `is_homography_reasonable` (число инлиеров, ошибка репроекции, положение и форма рамки, отношение площадей);
   - при успехе `last_good_H` обновляется с **экспоненциальным сглаживанием** (`smooth_homography`), что уменьшает рывки рамки.
3. Если по потоку не удалось получить корректную гомографию (мало точек, плохие проверки), выполняется **обновление по ORB‑матчингам**:
   - для всего кадра вычисляются ORB‑ключевые точки и дескрипторы;
   - выполняется knn‑matching (k=2) между дескрипторами объекта и текущего кадра;
   - по ratio‑test отбрасываются слабые совпадения;
   - при достаточном числе хороших матчей оценивается гомография `H` (RANSAC) и проводится та же серия проверок разумности;
   - в случае успеха `last_good_H` обновляется с сглаживанием.
4. Ведётся счётчик `frames_since_good`: если долго нет «хорошей» гомографии, считаем, что объект потерян, и временно не рисуем рамку (это защищает от ложных срабатываний).
5. На кадр наносится текстовая статистика (число совпадений, сколько кадров подряд нет хорошей гомографии).
6. Если есть актуальная `last_good_H`, по ней строится четырёхугольник объекта (`draw_tracked_object`) и рисуется зелёная рамка с подписью.

Таким образом, система комбинирует **два источника информации**:

- быстрый и плавный **оптический поток** для «мелких» сдвигов;
- более надёжный **ключевой‑точечный поиск по всему кадру** (ORB + BFMatcher + RANSAC), когда оптический поток даёт мало информации.

#### 3.3. Логические проверки гомографии

Чтобы избежать «улётевших» рамок и ложных срабатываний, каждая кандидатная гомография проходит набор проверок:

- **Число инлиеров**: должно быть не меньше `MIN_INLIERS` (для случая «объект — весь кадр» порог ослабляется).
- **Ошибка репроекции (RMSE)**: среднеквадратичное расстояние между спроецированными и фактическими точками не должно превышать `MAX_REPROJ_ERROR` (для полного кадра порог увеличивается).
- **Положение углов рамки**: все углы должны находиться в разумных пределах кадра (с небольшим запасом по границам).
- **Форма четырёхугольника**: отношение максимальной стороны к минимальной не должно быть слишком большим (`MAX_EDGE_RATIO`), чтобы отбрасывать сильно вытянутые «стрелы».
- **Площадь рамки**: отношение площади рамки к исходной площади объекта должно лежать в заданном диапазоне (`MIN_AREA_SCALE`, `MAX_AREA_SCALE`), при этом для случая с полным кадром диапазон расширен.

Если хотя бы одна проверка не пройдена, гомография считается некорректной и не используется.

#### 3.4. Запуск и использование

**Зависимости:**

- Python 3.x
- `opencv-python`
- `numpy`

Установка (пример для виртуального окружения):

```bash
pip install opencv-python numpy
```

**Запуск трекинга для всех тестовых видео:**

Из директории `lab2`:

```bash
python batch_tracker.py
```

- Скрипт пройдётся по всем файлам в `videos/input/` и создаст соответствующие файлы в `videos/output/` с суффиксом `_tracked`.
- Во время пакетной обработки окна OpenCV отключены.

**Запуск трекинга для одного видео:**

1. Поместите видео в папку `videos/input/` или укажите произвольный путь.
2. В файле `tracker.py` измените значения констант:

   - `INPUT_VIDEO_PATH` — путь к входному видео;
   - `OUTPUT_VIDEO_PATH` — путь к результирующему видео;
   - при необходимости `OBJECT_LABEL` — текст подписи.

3. Запустите:

```bash
python tracker.py
```

При `SHOW_WINDOWS = True` будет отображаться окно с процессом трекинга; выход — по клавише `q`.

### 4. Результаты работы и тестирования системы

Алгоритм был протестирован на нескольких видеороликах:

- **Тестовые видео с Мона Лизой:**
  - `mona-lisa.avi` — базовый вариант;
  - `mona-lisa-blur.avi` — видео с заметным блюром;
  - `mona-lisa-blur-extra-credit.avi` — ещё более размазанный вариант.
- **Собственное видео** с похожим по геометрии и текстуре объектом (`copybook.mov`).

Результаты сохранялись в папку `videos/output/` под именами:

- `mona-lisa_tracked.mov`
- `mona-lisa-blur_tracked.mov`
- `mona-lisa-blur-extra-credit_tracked.mov`
- `copybook_tracked.mov`

Наблюдения:

- На **чистом тестовом видео** (без сильного шума и блюра) трекинг стабилен: рамка хорошо следует за объектом при умеренных поворотах, масштабировании и небольших смещениях камеры.
- На **размытой версии** число совпадений ORB снижается, но комбинация оптического потока и ключевых точек позволяет удерживать корректную гомографию большую часть времени. При слишком сильном блюре и быстрой смене кадра рамка может временно пропадать.
- На **собственном видео** с объектом типа «книга/копибук» алгоритм демонстрирует устойчивое поведение при плавном движении камеры и частичной засветке/тени, при этом сильные закрытия и выход объекта из кадра приводят к отключению рамки до момента, когда появится достаточное количество хороших совпадений.

В целом, поведение соответствует ожиданиям для классического feature-based подхода: при наличии достаточного числа текстурных ключевых точек и умеренных искажениях гомография оценивается надёжно.

### 5. Выводы по работе

- Реализован трекер объекта на основе **ключевых точек ORB, сопоставления дескрипторов и оценки гомографии** с использованием RANSAC.
- Добавление **KLT‑оптического потока** и **сглаживания гомографии** позволяет сделать движение рамки более плавным и устойчивым к мелким дрожаниям и недостатку ORB‑совпадений на отдельных кадрах.
- Набор **логических проверок гомографии** (инлиеры, ошибка репроекции, форма и площадь рамки) значительно снижает количество ложных срабатываний, но при слишком жёстких порогах может приводить к потере объекта.
- Алгоритм хорошо работает для **плоских, текстурных объектов**, но чувствителен к сильному блюру, крупным закрытиям и случаям, когда объект занимает слишком малую часть кадра или почти полностью выходит из него.

